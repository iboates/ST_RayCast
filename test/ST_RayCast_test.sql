CREATE EXTENSION IF NOT EXISTS postgis;

DROP TABLE IF EXISTS point;
CREATE TABLE point (p_id INT4);
SELECT AddGeometryColumn('point', 'geom', 26910, 'POINT', 2);
INSERT INTO point (p_id, geom) VALUES (0, '01010000201E69000032A7C35E27331C419890C889A4C75441');
INSERT INTO point (p_id, geom) VALUES (1, '01010000201E690000BE1D9154DF321C41823BC84EA8C75441');
INSERT INTO point (p_id, geom) VALUES (2, '01010000201E690000A3CF08D2DE331C41F21C962EACC75441');
INSERT INTO point (p_id, geom) VALUES (3, '01010000201E69000009F0554CF9321C4112E4BAFE75C75441');

DROP TABLE IF EXISTS line;
CREATE TABLE line (l_id INT4);
SELECT AddGeometryColumn('line', 'geom', 26910, 'MULTILINESTRING', 2);
INSERT INTO line (l_id, geom) VALUES (0, '01050000201E6900000100000001020000000200000062F948E571311C412AF8F4A29CC75441065737FE90341C4159428341B9C75441');
INSERT INTO line (l_id, geom) VALUES (1, '01050000201E690000010000000102000000020000009881E97D1B321C41791EE215B2C7544120F583D8CE341C41752CD7BFA1C75441');
INSERT INTO line (l_id, geom) VALUES (2, '01050000201E69000001000000010200000002000000B875E6980F331C41BDCAD66477C754419C2327613C331C4164DB08BE74C75441');
INSERT INTO line (l_id, geom) VALUES (3, '01050000201E6900000100000001020000000800000040FEE0F359311C41439641FDA5C7544178A58AE90E331C41B36B8F7DA5C75441A4A311E417331C41C160B9DCA6C75441D05591FAF2321C41AD007F3CA7C754416CFC67EE06331C414C205B1BA9C75441183E6CB367331C4173E0CF5BA8C75441F6E807B466331C41FB8068BDA5C75441D0FB94ECAD341C4157F67B9DA5C75441');

DROP TABLE IF EXISTS poly;
CREATE TABLE poly (po_id INT4);
SELECT AddGeometryColumn('poly', 'geom', 26910, 'POLYGON', 2);
INSERT INTO poly (po_id, geom) VALUES (0, '01030000201E690000010000000C000000C2AAECF10D331C4110A872AFAAC754417EBA56735F331C41F31C015BA8C75441C2C41E8694331C41DFFB9AC9A2C75441B4261A9AD5331C41A0DC6AB2A6C75441C418E6928D331C4135133822ADC75441F1288EF9E0331C4176DEA02CB0C7544149DD588513341C4175B3D26FAEC75441AE315E770E341C418D5EF0A5B0C75441D7BD848270331C41F113B4ECB0C7544161A31409E8321C41A3B37162AFC7544107F79D30DF321C41D25D74DBACC75441C2AAECF10D331C4110A872AFAAC75441');
INSERT INTO poly (po_id, geom) VALUES (1, '01030000201E6900000100000005000000FCB00A2B2E331C412F5F9436A6C75441350BF07047331C419DA931FDA4C75441AFB820F955331C41C1E928B3A5C75441D45E79983E331C414DBF37CEA6C75441FCB00A2B2E331C412F5F9436A6C75441');
INSERT INTO poly (po_id, geom) VALUES (2, '01030000201E6900000100000005000000B731AF7355321C41A35548EE74C7544179A024DFD8321C41D0FF4A6772C75441954D1782E5321C41B6D3C2FA6AC754416DDAB9574B321C41A0D4DDB76FC75441B731AF7355321C41A35548EE74C75441');

DROP TABLE IF EXISTS test_lines_pointoutput;
CREATE TABLE test_lines_pointoutput AS (
	SELECT
		p.p_id AS p_id,
		(SELECT ST_RayCast(
			p.geom,
			ST_CollectionExtract(ST_Collect(l.geom), 2),
			out_geom_type := 'MULTIPOINT',
			num_rays := 64,
			max_ray_dist := 500
		)) AS geom
	FROM 
		point AS p,
		line AS l
	GROUP BY
		p.p_id,
		p.geom
);

DROP TABLE IF EXISTS test_lines_lineoutput;
CREATE TABLE test_lines_lineoutput AS (
	SELECT
		p.p_id AS p_id,
		(SELECT ST_RayCast(
			p.geom,
			ST_CollectionExtract(ST_Collect(l.geom), 2),
			out_geom_type := 'MULTILINESTRING',
			num_rays := 64,
			max_ray_dist := 500
		)) AS geom
	FROM 
		point AS p,
		line AS l
	GROUP BY
		p.p_id,
		p.geom
);

DROP TABLE IF EXISTS test_polys_pointoutput;
CREATE TABLE test_polys_pointoutput AS (
	SELECT
		p.p_id AS p_id,
		(SELECT ST_RayCast(
			p.geom,
			ST_CollectionExtract(ST_Collect(ST_ExteriorRing(po.geom)), 2),
			out_geom_type := 'MULTIPOINT',
			num_rays := 64,
			max_ray_dist := 500
		)) AS geom
	FROM 
		point AS p,
		poly AS po
	GROUP BY
		p.p_id,
		p.geom
);

DROP TABLE IF EXISTS test_polys_lineoutput;
CREATE TABLE test_polys_lineoutput AS (
	SELECT
		p.p_id AS p_id,
		(SELECT ST_RayCast(
			p.geom,
			ST_CollectionExtract(ST_Collect(ST_ExteriorRing(po.geom)), 2),
			out_geom_type := 'MULTILINESTRING',
			num_rays := 64,
			max_ray_dist := 500
		)) AS geom
	FROM 
		point AS p,
		poly AS po
	GROUP BY
		p.p_id,
		p.geom
);